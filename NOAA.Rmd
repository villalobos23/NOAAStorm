---
title: "NOAA Storm Data Analysis"
author: "Luis J. Villalobos"
date: "November 22 2015"
output: 
  html_document :
    keep_md: true
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.path='figure/')
library(R.utils)
library(calibrate)
library(data.table)
library(dplyr)
set.seed(1)
```
##Synopsis
The effects both human and economical of natural events and disasters go beyond fathom. This study uses the U.S. National Oceanic and Atmospheric Administration's (NOAA). The events in the database start in the year 1950 and end in November 2011, as time advances the records kept improve. The purpose of the analysis being made is to show the human and economical efects of those events and disasters in the years recorded by the NOAA.

##Data Processing
The data was extracted from the following [URL](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2) it is a bz2 zip file of around 49 Mbs. after being downloaded the following steps were made for its processing. For the processing of the data and its plotting we used R () and the following libraries R.utils, calibrate, data.table and dplyr.

We start by unzipping and reading the file with the records

```{r unzipIt, cache=TRUE,message=FALSE,warning=FALSE, echo=FALSE}
bunzip2("repdata-data-StormData.csv.bz2",remove=FALSE)
dtStorm <- fread("repdata-data-StormData.csv",header = T)
```

The contents and some questions regarding the description of data and its columns is in the following [URL](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf).

```{r sample, cache=TRUE, include=FALSE}
#dtStorm.sample <- sample_n(dtStorm,1000)
#write.csv(dtStorm.sample,"stormDataSample.csv")
#dtStorm <- fread("stormDataSample.csv")
```

We concentrate initially in quantifying the amount of human beings affected by natural events and disasters, by summarizing the amounts and grouping them by type of event. Afterwards they are sorted in descending order by the amounts of affected people.

```{r harmfulTables}

dtStorm.harmful <- dtStorm %>% 
    group_by(EVTYPE) %>% 
    summarize(FATALITIES = sum(FATALITIES,na.rm = T), 
              INJURIES = sum(INJURIES,na.rm=T)) 

setorder(dtStorm.harmful,-FATALITIES,-INJURIES)
```

Following, we have the processing of the economic effects of the events. First, we select those events that have an actual economic damage, both in property and in crops. 


The economic impact of the events is described in two columns one that shows a numeric amount, and other that describes a letter that is an exponential quantifier, 

* No cuantifier for no exponential number
* H for hundreds (even though it is not mentioned we asume from the analysis it is the intended meaning)
* K for thousands
* M for millions
* B for billions

```{r economicTables}
validExps <- c("","h","H","k","K","M","m","b","B")
dtStorm.economic <- dtStorm %>%
  select(EVTYPE,PROPDMG,PROPDMGEXP,CROPDMG,CROPDMGEXP) %>% 
  filter(PROPDMG > 0 | CROPDMG > 0, 
         PROPDMGEXP %in% validExps & CROPDMGEXP %in% validExps)
```

We transform the letters and replace them with the related values. 

```{r replaceEXP}
#Poperty Damage Exponential value substitution
dtStorm.economic$PROPDMGEXP[
  dtStorm.economic$PROPDMGEXP == 'B' | dtStorm.economic$PROPDMGEXP == 'b'] <- 1000000000
dtStorm.economic$PROPDMGEXP[
  dtStorm.economic$PROPDMGEXP == 'M' | dtStorm.economic$PROPDMGEXP == 'm'] <- 1000000
dtStorm.economic$PROPDMGEXP[
  dtStorm.economic$PROPDMGEXP == 'K'| dtStorm.economic$PROPDMGEXP == 'k'] <- 1000
dtStorm.economic$PROPDMGEXP[
  dtStorm.economic$PROPDMGEXP == 'H'| dtStorm.economic$PROPDMGEXP == 'h'] <- 100
dtStorm.economic$PROPDMGEXP[dtStorm.economic$PROPDMGEXP == ''] <- 1
#Crop Damage Exponential value substitution
dtStorm.economic$CROPDMGEXP[
  dtStorm.economic$CROPDMGEXP == 'B' |dtStorm.economic$CROPDMGEXP == 'b'] <- 1000000000
dtStorm.economic$CROPDMGEXP[
  dtStorm.economic$CROPDMGEXP == 'M' |dtStorm.economic$CROPDMGEXP == 'm'] <- 1000000
dtStorm.economic$CROPDMGEXP[
  dtStorm.economic$CROPDMGEXP == 'K' |dtStorm.economic$CROPDMGEXP == 'k'] <- 1000
dtStorm.economic$CROPDMGEXP[
  dtStorm.economic$CROPDMGEXP == 'H' |dtStorm.economic$CROPDMGEXP == 'h'] <- 100
dtStorm.economic$CROPDMGEXP[dtStorm.economic$CROPDMGEXP == ''] <- 1
```

To prevent arithmetic errors we transform into numeric values the assigned exponential coefficents

```{r transformLevels}
dtStorm.economic$PROPDMGEXP <- as.numeric(dtStorm.economic$PROPDMGEXP)
dtStorm.economic$CROPDMGEXP <- as.numeric(dtStorm.economic$CROPDMGEXP)
```

With the transformation done, we create a new column with the total cost that is generated by adding the amount of crop and property damage. Afterwards we sort them by that generated value, and group them by event type.

```{r calculateCost}
dtStorm.economic <- mutate(
  dtStorm.economic,totalCost = (PROPDMG*PROPDMGEXP)+(CROPDMG*CROPDMGEXP))

dtStorm.economic <- dtStorm.economic %>%
  group_by(EVTYPE) %>%
  summarize(totalCost = sum(totalCost,na.rm=T))

setorder(dtStorm.economic,-totalCost)
```

##Results

First we show and plot the first 10 most fatal type of natural events and disasters in the period.

```{r plotFatalities}
fatalEvents <- dtStorm.harmful[dtStorm.harmful$FATALITIES>0]
head(fatalEvents,n=10)
fatalEvents <- head(fatalEvents,n = 10)
plot(fatalEvents$FATALITIES, ylab = "Amount of Fatalities")
textxy(1:nrow(fatalEvents),fatalEvents$FATALITIES,fatalEvents$EVTYPE)
```

Following the display and plot of the total injuries by event type. At this point we can se that the events that are present in the first category of fatal events are quite similar to the following plot.

```{r plotInjuries}
harmfulEvents <- dtStorm.harmful[dtStorm.harmful$INJURIES > 0]
head(harmfulEvents,n=10)
harmfulEvents <- head(harmfulEvents, n=10)
plot(harmfulEvents$INJURIES, ylab = "Amount of Injuries")
textxy(1:nrow(harmfulEvents),harmfulEvents$INJURIES,harmfulEvents$EVTYPE)
```

The 10 most harmful events in the economic sense are not so similar than the ones presented in the first two plots. 

```{r plotEconomicHarm}
head(dtStorm.economic,n=10)
dtStorm.economic <- head(dtStorm.economic,n=10)
plot(dtStorm.economic$totalCost,ylab = "Total damage in USD($)")
textxy(1:nrow(dtStorm.economic),dtStorm.economic$totalCost, dtStorm.economic$EVTYPE)
```

It is important to note the great difference between the first most ecomomic harmful event and the rest of the list. 
